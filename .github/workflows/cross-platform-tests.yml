name: ક્રોસ-પ્લેટફોર્મ ટેસ્ટ (Cross-Platform Tests)

# વર્કફ્લો ચાલુ કરવાના કારણો
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # મેન્યુઅલ રન માટે

# Permissions for the workflow
permissions:
  contents: read

# Jobs
jobs:
  test:
    name: "ટેસ્ટ ${{ matrix.os }} પર Python ${{ matrix.python-version }}"
    runs-on: ${{ matrix.os }}
    
    # Strategy matrix for testing on multiple platforms and Python versions
    strategy:
      fail-fast: false  # બધા પ્લેટફોર્મ પર ટેસ્ટ ચાલુ રાખો, ભલે એક fail થાય
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        # માત્ર latest Python વર્ઝન macOS અને Windows પર ટેસ્ટ કરો (CI time બચાવવા માટે)
        exclude:
          - os: macos-latest
            python-version: '3.8'
          - os: macos-latest  
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.8'
          - os: windows-latest
            python-version: '3.9'
    
    env:
      PYTHONUTF8: 1
      PYTHONIOENCODING: utf-8

    steps:
    - name: કોડ ડાઉનલોડ (Checkout code)
      uses: actions/checkout@v4

    - name: Python ${{ matrix.python-version }} સેટઅપ (Setup Python)
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Dependencies ઇન્સ્ટોલ (Install dependencies)
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
        # વૈકલ્પિક: development dependencies
        if [ -f requirements-dev.txt ]; then
          python -m pip install -r requirements-dev.txt
        fi
      shell: bash  # Windows પર પણ bash ઉપયોગ કરો

    - name: મૂળભૂત ટેસ્ટ (Run basic tests)
      run: |
        python -m unittest ટેસ્ટ.ટેસ્ટ_અનુવાદક -v
        python -m unittest ટેસ્ટ.પ્લેટફોર્મ_ટેસ્ટ -v
        # Run new agent tests
        python -m unittest tests.test_agents -v
      shell: bash

    - name: ઉદાહરણ ટેસ્ટ (Run example tests)  
      run: |
        python -m unittest ટેસ્ટ.ઉદાહરણ_ટેસ્ટ -v
      shell: bash

    - name: Agent Integration Test
      run: |
        # Run agents on the codebase itself
        python run_agents.py ગુજરાતી_પાઈથન/
      shell: bash

    - name: બધા ટેસ્ટ એકસાથે (Run all tests together)
      run: |
        echo "Running individual test modules..."
        python -m unittest ટેસ્ટ.ટેસ્ટ_અનુવાદક -v
        python -m unittest ટેસ્ટ.પ્લેટફોર્મ_ટેસ્ટ -v  
        python -m unittest ટેસ્ટ.ઉદાહરણ_ટેસ્ટ -v
        python -m unittest tests.test_agents -v
      shell: bash

    - name: કમાંડ લાઇન ઇન્ટરફેસ ટેસ્ટ (Test CLI interface)
      run: |
        # હેલ્પ ટેસ્ટ કરો
        python મુખ્ય.py --help
        
        # કીવર્ડ લિસ્ટ ટેસ્ટ કરો  
        python મુખ્ય.py --keywords
        
        # કીવર્ડ સર્ચ ટેસ્ટ કરો
        python મુખ્ય.py --search "છાપો"
        
        # સરળ ઉદાહરણ ચલાવો
        python મુખ્ય.py ઉદાહરણો/સરળ_ડેમો.py
        
        # અનુવાદ ટેસ્ટ કરો
        python મુખ્ય.py --translate ઉદાહરણો/સરળ_ડેમો.py
      shell: bash

    - name: પ્લેટફોર્મ માહિતી (Platform info)
      run: |
        echo "Platform Information:"
        python <<EOF
        import sys
        import platform
        import locale
        print(f"  OS: {platform.system()} {platform.release()}")
        print(f"  Architecture: {platform.machine()}")
        print(f"  Python: {sys.version}")
        print(f"  Encoding: {sys.getdefaultencoding()}")
        print(f"  Locale: {locale.getdefaultlocale()}")
        print(f"  File system encoding: {sys.getfilesystemencoding()}")
        print()
        EOF
        echo "Unicode Support Test:"
        python -c "gujarati_text = 'ગુજરાતી પાઈથન'; print(f'  Gujarati text: {gujarati_text}'); print(f'  Length: {len(gujarati_text)} characters'); print(f'  Encoded length: {len(gujarati_text.encode(\"utf-8\"))} bytes')"
      shell: bash

  # નિષ્કર્ષ જોબ - બધા પ્લેટફોર્મ પર સફળતા ચકાસે છે
  conclude:
    name: નિષ્કર્ષ (Test Results Summary)
    runs-on: ubuntu-latest
    needs: test
    if: always()  # હંમેશા ચાલાવો, ભલે tests fail થાય
    
    steps:
    - name: તમામ પ્લેટફોર્મ સફળતા (All platforms success)
      if: ${{ needs.test.result == 'success' }}
      run: |
        echo "બધા પ્લેટફોર્મ પર તમામ ટેસ્ટ સફળ!"
        echo "Linux (Ubuntu), Windows, and macOS testing completed successfully"
        echo "Python 3.8-3.12 compatibility verified" 
        echo "Gujarati Python examples working on all platforms"
        echo "Cross-platform UTF-8 support confirmed"

    - name: કેટલાક ટેસ્ટ નિષ્ફળ (Some tests failed)  
      if: ${{ needs.test.result != 'success' }}
      run: |
        echo "કેટલાક પ્લેટફોર્મ પર ટેસ્ટ નિષ્ફળ"
        echo "Please check the individual job results above"
        exit 1

  # વૈકલ્પિક: લિન્ટિંગ જોબ
  lint:
    name: કોડ ક્વોલિટી (Code Quality)
    runs-on: ubuntu-latest
    if: false  # હાલ માટે disabled, enable કરવા માટે true કરો
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Lint with flake8
      run: |
        pip install flake8
        # મુખ્ય કોડ ડિરેક્ટરી lint કરો, Gujarati ફાઈલ નામો સાથે સમસ્યા હોઈ શકે
        # flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        echo "Linting disabled for Gujarati file names compatibility"